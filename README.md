# Bulk preparing habitat and terrain

These notebooks demonstrate how to prepare habitat and terrain maps for a given list of bird species. One may download range shapefiles for a specified list of bird species from eBird. These, along with the terrain map, are reprojected to the selected CRS. Then the habitat maps for each species are produced by masking the terrain map with the range shapefiles.

## Notebooks

These notebooks provide insight into how to use the RedList and HabitatGenerator modules defined in `habitats.py` to produce habitat and terrain files for a list of species.

- test_run.ipynb: notebook for basic testing of module functionality on a small square of terrain

- ca_birds_habitats.ipynb: notebook for generating terrain and habitats for bird species in California

## Preparation

You will need to have R and an access key for the `ebirdst` R package in order to run this. Refer to the Installation and Data Access sections in https://cornelllabofornithology.github.io/ebirdst/index.html for instructions on setting this up.

You will also need to have a `birdmaps/config.py` file defining the constants `EBIRD_KEY` and `REDLIST_KEY`. This is necessary to download bird species ranges and obtain necessary information about birds. For UCSC researchers, keys are available in the shared drive:

- https://drive.google.com/drive/u/0/folders/1dMdx0zlitb5N2i1GHFtv49tFFxQiHg2X
- https://drive.google.com/drive/u/0/folders/132Aas6w6LKdsOEPaKagPNZT9-wLlZq4j

## Parameters

File paths:

- species_list_path
    - Path to txt file of the bird species to download eBird ranges for
    - Inputs are 6-letter eBird species codes on individual lines

- terrain_path
    - Path to terrain raster

- terrain_codes_path
    - Output path to a terrain codes csv containing all unique values in the terrain
    - If not generated, it can be generated by setting reproject_inputs to True

- output_folder
    - Folder to place habitat output files and terrain-to-resistance csv files in

Other configuration settings:

- resolution
    - Resolution in the units of the chosen CRS
    - Set to None to just use the current resolution of the terrain raster

- resampling
    - Type of resampling to use when reprojecting the input tiffs, see https://gdal.org/programs/gdalwarp.html#cmdoption-gdalwarp-r for valid arguments

- crs
    - Chosen CRS to reproject all input files to, as a WKT string

- bounds, padding
    - (xmin/left, ymin/bottom, xmax/right, ymax/top) to crop habitats to and padding in units of chosen CRS to add around the bounds
    - Set bounds to None if you don't want to crop

- refine_method
    - Choose what terrain should be considered as good for habitat:
        - forest (default, all forest terrains)
        - forest_add308 (forest terrains plus the terrain with map code 308: "Shrubland â€“ Mediterranean-type shrubby vegetation")
        - allsuitable (all terrains deemed suitable for the relevant species by the IUCN Red List)
        - majoronly (all terrains deemed of major importance for the relevant species by the IUCN Red List)

- reproject_inputs
    - Set reproject_inputs to True to reproject terrain if necessary
    - Produces new terrain file with provided resolution/resampling/CRS setting and terrain_codes_path file that can be swapped in as inputs in future runs, in which case this can be set to false

## Methods

The main input files are the terrain geotiff and the list of bird species to generate habitats for. The list of bird species should be given as a text file containing the relevant eBird 6-letter codes on separate lines. FIll in each of the parameters explained above as necessary.

If you've never used the terrain geotiff with the specific set of resolution, resampling mode, CRS, and bounds/padding before, you should set reproject_inputs to true. This produces a new terrain that is added to the same folder location as the original input files and which can be reused in future runs with reproject_inputs set to false. The advantage of this setup is that since you may find yourself using the same settings and source input file for multiple runs, time does not need to be spent reprojecting the same terrain input on every run.

A small amount of setup is done before the real processing happens. We do some checks for the parameters, checking that they seem reasonable and that the specified files and folders exist. The species list to process is read into a list of species codes for later use, including making species folders inside the main output folder. One may also want to sometimes use these codes in other file names, such as for species-specific shapefiles or outputs.

Data about each species' preferred terrain types is then collected from the IUCN Red List API. For cases in which the eBird name differs from that on the IUCN Red List, manually corrections might need to be specified in this step.

Range shapefiles for each bird species will be downloaded from eBird into the input folders. These range maps serve to outline initial rough boundaries of the birds' habitats.

A default terrain-to-resistance conversion file is generated in which terrains deemed both suitable and of major importance have a resistance of 0, suitable ones have a resistance of 0.1, and all others within the terrain extent have a resistance of 1. This is outputted as a csv in the species' specific output folder.

Lastly, the intersection between the range shapefile and habitable terrain is performed for each bird species. The habitable terrain depends on refine_method; it can be terrain of major importance only, for instance, or it may just be the general forest terrain. Like the terrain-to-resistance files, these are outputted in the species' specific output folder.

## Known issues

- The eBird and IUCN Redlist scientific names don't always match up for certain bird species (like white-headed woodpecker). The IUCN Redlist API only accepts scientific names for queries, so the species code for the white-headed woodpecker from eBird has to be manually matched to the corresponding entry in the IUCN Redlist.
